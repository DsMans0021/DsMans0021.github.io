<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chess Arena | Mohamed Abdelaziz</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
    <link rel="icon" href="https://avatars.githubusercontent.com/u/136956569?v=4" />
    <style>
        body { font-family: 'Inter', sans-serif; }
        .glass { background: rgba(255,255,255,0.15); box-shadow: 0 8px 32px 0 rgba(31,38,135,0.37); backdrop-filter: blur(8px); border-radius: 1.5rem; border: 1px solid rgba(255,255,255,0.18); }
        .gradient-text { background: linear-gradient(90deg, #6366f1, #06b6d4, #a21caf); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; }
        .board-blur { filter: blur(10px) grayscale(40%); pointer-events: none; }
        .square { width: 12.5%; padding-bottom: 12.5%; position: relative; }
        .square > div { position: absolute; inset: 0; }
        .light { background-color: #f0d9b5; }
        .dark { background-color: #b58863; }
        .board-grid { display: flex; flex-wrap: wrap; border-radius: 0.75rem; overflow: hidden; border: 2px solid rgba(0,0,0,0.1); }
        .tag { font-variant-numeric: tabular-nums; }
        .piece-img { position: absolute; inset: 0; background-size: 88% 88%; background-repeat: no-repeat; background-position: center; pointer-events: none; }
        .piece-sprite { position: absolute; inset: 0; background-repeat: no-repeat; background-position: center; background-size: 600% 200%; pointer-events: none; }
        .hl-selected { outline: 3px solid rgba(99,102,241,0.9); box-shadow: inset 0 0 0 9999px rgba(99,102,241,0.12); }
        .hl-dot::after { content: ''; position: absolute; top: 50%; left: 50%; width: 22%; height: 22%; transform: translate(-50%, -50%); border-radius: 999px; background: rgba(16,185,129,0.9); box-shadow: 0 0 0 4px rgba(16,185,129,0.2); }
        .hl-capture::after { background: rgba(239,68,68,0.9); box-shadow: 0 0 0 4px rgba(239,68,68,0.2); }
        .hl-last { box-shadow: inset 0 0 0 9999px rgba(250,204,21,0.18); }
        .board-flipped { transform: rotate(180deg); }
        .board-flipped .piece-img { transform: rotate(180deg); }
    </style>
</head>

<body class="bg-gradient-to-br from-indigo-100 via-sky-100 to-purple-100 text-gray-900">

    <nav class="fixed w-full z-20 top-0 left-0 bg-white/80 backdrop-blur shadow-sm">
        <div class="max-w-6xl mx-auto flex justify-between items-center px-4 sm:px-6 py-3">
            <div class="flex items-center gap-2">
                <img src="https://avatars.githubusercontent.com/u/136956569?v=4" alt="Profile" class="w-8 h-8 sm:w-10 sm:h-10 rounded-full border-2 border-indigo-400" />
                <span class="font-bold text-indigo-700 text-base sm:text-lg">Mohamed Abdelaziz</span>
            </div>
            <div class="hidden lg:flex gap-3">
                <a href="index.html" class="inline-flex items-center gap-2 px-4 py-2 bg-gradient-to-r from-cyan-400 to-indigo-600 text-white rounded-full shadow hover:scale-105 transition">
                    <i class="fa-solid fa-arrow-left"></i> Back to Home
                </a>
                <a href="tools.html" class="inline-flex items-center gap-2 px-4 py-2 bg-white text-indigo-700 border border-indigo-200 rounded-full shadow hover:bg-indigo-50 transition">
                    <i class="fa-solid fa-toolbox"></i> Tools
                </a>
            </div>
            <a href="index.html" class="lg:hidden text-indigo-700 text-xl" aria-label="Back">
                <i class="fa-solid fa-arrow-left"></i>
            </a>
        </div>
    </nav>

    <main class="pt-24 px-4 pb-16">
        <div class="max-w-6xl mx-auto">
            <div class="glass p-6 sm:p-8 lg:p-10 shadow-2xl bg-white/70 border border-indigo-200">
                <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                    <div>
                        <h1 class="text-2xl sm:text-3xl lg:text-4xl font-extrabold gradient-text">Chess Arena</h1>
                        <p class="text-gray-700">Chess Arena — four live boards, instant invites, real‑time play, and a slick spectator mode. Claim a seat, reveal a board, and battle in style.</p>
                    </div>
                    <div class="flex flex-wrap gap-2">
                        <button id="bookSlotBtn" class="inline-flex items-center gap-2 px-4 py-2 rounded-full text-white bg-gradient-to-r from-indigo-600 via-cyan-500 to-purple-600 hover:from-purple-600 hover:via-indigo-600 hover:to-cyan-500 shadow">
                            <i class="fa-solid fa-clock"></i> Book a Match
                        </button>
                        <button id="clearLocalBtn" class="inline-flex items-center gap-2 px-4 py-2 rounded-full text-indigo-700 bg-white border border-indigo-200 hover:bg-indigo-50">
                            <i class="fa-solid fa-broom"></i> Reset (local)
                        </button>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
                    <div id="board-card-1" class="glass p-4 bg-white/70 border border-indigo-100">
                        <div class="flex items-start justify-between mb-3">
                            <div class="flex items-center gap-2">
                                <span class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-indigo-600 text-white font-bold tag">1</span>
                                <h2 class="font-semibold text-indigo-800">Board 1</h2>
                            </div>
                            <div class="text-sm text-gray-600 flex items-center gap-3">
                                <span><i class="fa-solid fa-eye"></i> <span id="watchers-1">0</span></span>
                                <a id="invite-1" href="#" class="text-indigo-700 hover:underline"><i class="fa-solid fa-link"></i> Invite</a>
                            </div>
                        </div>
                        <div class="mb-3 flex items-center justify-between text-sm">
                            <span id="status-1" class="text-gray-700">Idle</span>
                            <div class="flex items-center gap-1 bg-white/70 backdrop-blur border border-indigo-100 rounded-full p-1 shadow-sm">
                                <button data-board="1" class="join-btn w-8 h-8 grid place-items-center rounded-full text-white bg-indigo-600 hover:bg-indigo-700" title="Start/Join" aria-label="Start/Join"><i class="fa-solid fa-user-plus text-xs"></i></button>
                                <button data-board="1" class="leave-btn w-8 h-8 grid place-items-center rounded-full text-indigo-700 bg-white hover:bg-indigo-50 border border-indigo-100" title="Leave" aria-label="Leave"><i class="fa-solid fa-door-open text-xs"></i></button>
                                <span class="w-px h-5 bg-indigo-100 mx-1"></span>
                                <button data-board="1" class="flip-btn w-8 h-8 grid place-items-center rounded-full text-indigo-700 bg-white hover:bg-indigo-50 border border-indigo-100" title="Flip Board" aria-label="Flip Board"><i class="fa-solid fa-arrows-rotate text-xs"></i></button>
                                <button data-board="1" class="offer-draw-btn w-8 h-8 grid place-items-center rounded-full text-white bg-emerald-600 hover:bg-emerald-700" title="Offer Draw" aria-label="Offer Draw"><i class="fa-solid fa-handshake text-xs"></i></button>
                                <button data-board="1" class="offer-takeback-btn w-8 h-8 grid place-items-center rounded-full text-white bg-amber-600 hover:bg-amber-700" title="Request Takeback" aria-label="Request Takeback"><i class="fa-solid fa-rotate-left text-xs"></i></button>
                                <button data-board="1" class="resign-btn w-8 h-8 grid place-items-center rounded-full text-white bg-rose-600 hover:bg-rose-700" title="Resign" aria-label="Resign"><i class="fa-solid fa-flag text-xs"></i></button>
                            </div>
                        </div>
                        <div class="mb-2 text-xs" id="offer-area-1"></div>
                        <div class="relative">
                            <div id="board-1" class="board-grid aspect-square bg-white"></div>
                            <div class="absolute inset-0 flex items-center justify-center">
                                <button data-board="1" class="reveal-btn inline-flex items-center gap-2 px-4 py-2 rounded-full text-white bg-gradient-to-r from-indigo-600 to-cyan-500 shadow">
                                    <i class="fa-solid fa-eye"></i> Reveal this match
                                </button>
                            </div>
                        </div>
                    </div>

                    <div id="board-card-2" class="glass p-4 bg-white/70 border border-indigo-100">
                        <div class="flex items-start justify-between mb-3">
                            <div class="flex items-center gap-2">
                                <span class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-indigo-600 text-white font-bold tag">2</span>
                                <h2 class="font-semibold text-indigo-800">Board 2</h2>
                            </div>
                            <div class="text-sm text-gray-600 flex items-center gap-3">
                                <span><i class="fa-solid fa-eye"></i> <span id="watchers-2">0</span></span>
                                <a id="invite-2" href="#" class="text-indigo-700 hover:underline"><i class="fa-solid fa-link"></i> Invite</a>
                            </div>
                        </div>
                        <div class="mb-3 flex items-center justify-between text-sm">
                            <span id="status-2" class="text-gray-700">Idle</span>
                            <div class="flex items-center gap-1 bg-white/70 backdrop-blur border border-indigo-100 rounded-full p-1 shadow-sm">
                                <button data-board="2" class="join-btn w-8 h-8 grid place-items-center rounded-full text-white bg-indigo-600 hover:bg-indigo-700" title="Start/Join" aria-label="Start/Join"><i class="fa-solid fa-user-plus text-xs"></i></button>
                                <button data-board="2" class="leave-btn w-8 h-8 grid place-items-center rounded-full text-indigo-700 bg-white hover:bg-indigo-50 border border-indigo-100" title="Leave" aria-label="Leave"><i class="fa-solid fa-door-open text-xs"></i></button>
                                <span class="w-px h-5 bg-indigo-100 mx-1"></span>
                                <button data-board="2" class="flip-btn w-8 h-8 grid place-items-center rounded-full text-indigo-700 bg-white hover:bg-indigo-50 border border-indigo-100" title="Flip Board" aria-label="Flip Board"><i class="fa-solid fa-arrows-rotate text-xs"></i></button>
                                <button data-board="2" class="offer-draw-btn w-8 h-8 grid place-items-center rounded-full text-white bg-emerald-600 hover:bg-emerald-700" title="Offer Draw" aria-label="Offer Draw"><i class="fa-solid fa-handshake text-xs"></i></button>
                                <button data-board="2" class="offer-takeback-btn w-8 h-8 grid place-items-center rounded-full text-white bg-amber-600 hover:bg-amber-700" title="Request Takeback" aria-label="Request Takeback"><i class="fa-solid fa-rotate-left text-xs"></i></button>
                                <button data-board="2" class="resign-btn w-8 h-8 grid place-items-center rounded-full text-white bg-rose-600 hover:bg-rose-700" title="Resign" aria-label="Resign"><i class="fa-solid fa-flag text-xs"></i></button>
                            </div>
                        </div>
                        <div class="mb-2 text-xs" id="offer-area-2"></div>
                        <div class="relative">
                            <div id="board-2" class="board-grid aspect-square bg-white"></div>
                            <div class="absolute inset-0 flex items-center justify-center">
                                <button data-board="2" class="reveal-btn inline-flex items-center gap-2 px-4 py-2 rounded-full text-white bg-gradient-to-r from-indigo-600 to-cyan-500 shadow">
                                    <i class="fa-solid fa-eye"></i> Reveal this match
                                </button>
                            </div>
                        </div>
                    </div>

                    <div id="board-card-3" class="glass p-4 bg-white/70 border border-indigo-100">
                        <div class="flex items-start justify-between mb-3">
                            <div class="flex items-center gap-2">
                                <span class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-indigo-600 text-white font-bold tag">3</span>
                                <h2 class="font-semibold text-indigo-800">Board 3</h2>
                            </div>
                            <div class="text-sm text-gray-600 flex items-center gap-3">
                                <span><i class="fa-solid fa-eye"></i> <span id="watchers-3">0</span></span>
                                <a id="invite-3" href="#" class="text-indigo-700 hover:underline"><i class="fa-solid fa-link"></i> Invite</a>
                            </div>
                        </div>
                        <div class="mb-3 flex items-center justify-between text-sm">
                            <span id="status-3" class="text-gray-700">Idle</span>
                            <div class="flex items-center gap-1 bg-white/70 backdrop-blur border border-indigo-100 rounded-full p-1 shadow-sm">
                                <button data-board="3" class="join-btn w-8 h-8 grid place-items-center rounded-full text-white bg-indigo-600 hover:bg-indigo-700" title="Start/Join" aria-label="Start/Join"><i class="fa-solid fa-user-plus text-xs"></i></button>
                                <button data-board="3" class="leave-btn w-8 h-8 grid place-items-center rounded-full text-indigo-700 bg-white hover:bg-indigo-50 border border-indigo-100" title="Leave" aria-label="Leave"><i class="fa-solid fa-door-open text-xs"></i></button>
                                <span class="w-px h-5 bg-indigo-100 mx-1"></span>
                                <button data-board="3" class="flip-btn w-8 h-8 grid place-items-center rounded-full text-indigo-700 bg-white hover:bg-indigo-50 border border-indigo-100" title="Flip Board" aria-label="Flip Board"><i class="fa-solid fa-arrows-rotate text-xs"></i></button>
                                <button data-board="3" class="offer-draw-btn w-8 h-8 grid place-items-center rounded-full text-white bg-emerald-600 hover:bg-emerald-700" title="Offer Draw" aria-label="Offer Draw"><i class="fa-solid fa-handshake text-xs"></i></button>
                                <button data-board="3" class="offer-takeback-btn w-8 h-8 grid place-items-center rounded-full text-white bg-amber-600 hover:bg-amber-700" title="Request Takeback" aria-label="Request Takeback"><i class="fa-solid fa-rotate-left text-xs"></i></button>
                                <button data-board="3" class="resign-btn w-8 h-8 grid place-items-center rounded-full text-white bg-rose-600 hover:bg-rose-700" title="Resign" aria-label="Resign"><i class="fa-solid fa-flag text-xs"></i></button>
                            </div>
                        </div>
                        <div class="mb-2 text-xs" id="offer-area-3"></div>
                        <div class="relative">
                            <div id="board-3" class="board-grid aspect-square bg-white"></div>
                            <div class="absolute inset-0 flex items-center justify-center">
                                <button data-board="3" class="reveal-btn inline-flex items-center gap-2 px-4 py-2 rounded-full text-white bg-gradient-to-r from-indigo-600 to-cyan-500 shadow">
                                    <i class="fa-solid fa-eye"></i> Reveal this match
                                </button>
                            </div>
                        </div>
                    </div>

                    <div id="board-card-4" class="glass p-4 bg-white/70 border border-indigo-100">
                        <div class="flex items-start justify-between mb-3">
                            <div class="flex items-center gap-2">
                                <span class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-indigo-600 text-white font-bold tag">4</span>
                                <h2 class="font-semibold text-indigo-800">Board 4</h2>
                            </div>
                            <div class="text-sm text-gray-600 flex items-center gap-3">
                                <span><i class="fa-solid fa-eye"></i> <span id="watchers-4">0</span></span>
                                <a id="invite-4" href="#" class="text-indigo-700 hover:underline"><i class="fa-solid fa-link"></i> Invite</a>
                            </div>
                        </div>
                        <div class="mb-3 flex items-center justify-between text-sm">
                            <span id="status-4" class="text-gray-700">Idle</span>
                            <div class="flex items-center gap-1 bg-white/70 backdrop-blur border border-indigo-100 rounded-full p-1 shadow-sm">
                                <button data-board="4" class="join-btn w-8 h-8 grid place-items-center rounded-full text-white bg-indigo-600 hover:bg-indigo-700" title="Start/Join" aria-label="Start/Join"><i class="fa-solid fa-user-plus text-xs"></i></button>
                                <button data-board="4" class="leave-btn w-8 h-8 grid place-items-center rounded-full text-indigo-700 bg-white hover:bg-indigo-50 border border-indigo-100" title="Leave" aria-label="Leave"><i class="fa-solid fa-door-open text-xs"></i></button>
                                <span class="w-px h-5 bg-indigo-100 mx-1"></span>
                                <button data-board="4" class="flip-btn w-8 h-8 grid place-items-center rounded-full text-indigo-700 bg-white hover:bg-indigo-50 border border-indigo-100" title="Flip Board" aria-label="Flip Board"><i class="fa-solid fa-arrows-rotate text-xs"></i></button>
                                <button data-board="4" class="offer-draw-btn w-8 h-8 grid place-items-center rounded-full text-white bg-emerald-600 hover:bg-emerald-700" title="Offer Draw" aria-label="Offer Draw"><i class="fa-solid fa-handshake text-xs"></i></button>
                                <button data-board="4" class="offer-takeback-btn w-8 h-8 grid place-items-center rounded-full text-white bg-amber-600 hover:bg-amber-700" title="Request Takeback" aria-label="Request Takeback"><i class="fa-solid fa-rotate-left text-xs"></i></button>
                                <button data-board="4" class="resign-btn w-8 h-8 grid place-items-center rounded-full text-white bg-rose-600 hover:bg-rose-700" title="Resign" aria-label="Resign"><i class="fa-solid fa-flag text-xs"></i></button>
                            </div>
                        </div>
                        <div class="mb-2 text-xs" id="offer-area-4"></div>
                        <div class="relative">
                            <div id="board-4" class="board-grid aspect-square bg-white"></div>
                            <div class="absolute inset-0 flex items-center justify-center">
                                <button data-board="4" class="reveal-btn inline-flex items-center gap-2 px-4 py-2 rounded-full text-white bg-gradient-to-r from-indigo-600 to-cyan-500 shadow">
                                    <i class="fa-solid fa-eye"></i> Reveal this match
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mt-8 text-sm text-gray-700">
                    <p class="text-center">Tip: Copy an invite from any board to bring a friend straight into that match.</p>
                </div>
            </div>
        </div>
    </main>

    
    <script>
        window.FIREBASE_CONFIG = {
          apiKey: "AIzaSyCDfFDf8PCKKKCBWFPhpRX_ln-qnU61oFk",
          authDomain: "chess-0021.firebaseapp.com",
          databaseURL: "https://chess-0021-default-rtdb.europe-west1.firebasedatabase.app/",
          projectId: "chess-0021",
          storageBucket: "chess-0021.firebasestorage.app",
          messagingSenderId: "917845016237",
          appId: "1:917845016237:web:a2f7ad1d637823cc409024"
        };
        window.CHESS_SPRITE_URL = window.CHESS_SPRITE_URL || 'chess_pieces.png';
    </script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.13.4/chess.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
    <script>
        // Build static chessboard UI (no engine) and handle reveal/watch logic
        const BOARD_IDS = [1,2,3,4];
        const STORAGE_KEYS = {
            activeBoard: 'chess_active_board',
            watchersPrefix: 'chess_watchers_',
            queue: 'chess_queue',
            busyBoards: 'chess_busy_boards'
        };

        // Realtime (Firebase) setup: dual-mode
        const realtime = {
            enabled: false,
            app: null,
            db: null,
            myId: null,
            currentWatching: null
        };
        const boardHasTwoPlayers = new Map();
        const boardMyColor = new Map();
        const boardFen = new Map();
        const boardTurn = new Map();

        (function tryInitFirebase(){
            try {
                if (window.FIREBASE_CONFIG && firebase?.initializeApp) {
                    realtime.app = firebase.initializeApp(window.FIREBASE_CONFIG);
                    realtime.db = firebase.database();
                    realtime.enabled = true;
                    realtime.myId = localStorage.getItem('chess_client_id') || (crypto.randomUUID ? crypto.randomUUID() : String(Date.now()));
                    localStorage.setItem('chess_client_id', realtime.myId);
                    subscribeBusyBoardsRealtime();
                    BOARD_IDS.forEach(id => subscribeWatchersRealtime(id));
                }
            } catch (e) {
                // stay in local-only mode
            }
        })();

        function initBoards() {
            BOARD_IDS.forEach(id => {
                const boardEl = document.getElementById(`board-${id}`);
                buildBoardSquares(boardEl);
                // Ensure pieces render even before realtime events
                renderFenToBoard(boardEl, 'rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR');
            });
        }

        function buildBoardSquares(container) {
            container.innerHTML = '';
            container.classList.add('rounded-xl', 'overflow-hidden');
            for (let row = 0; row < 8; row++) {
                for (let col = 0; col < 8; col++) {
                    const square = document.createElement('div');
                    square.className = 'square';
                    const inner = document.createElement('div');
                    const isLight = (row + col) % 2 === 0;
                    inner.className = isLight ? 'light' : 'dark';
                    const file = String.fromCharCode('a'.charCodeAt(0) + col);
                    const rank = 8 - row;
                    inner.dataset.square = `${file}${rank}`;
                    square.appendChild(inner);
                    container.appendChild(square);
                }
            }
        }

        function getQueue() {
            try { return JSON.parse(localStorage.getItem(STORAGE_KEYS.queue) || '[]'); } catch { return []; }
        }
        function setQueue(q) {
            localStorage.setItem(STORAGE_KEYS.queue, JSON.stringify(q));
        }
        function getBusyBoards() {
            if (realtime.enabled) {
                // In realtime mode, local getter is unused by subscribers; fallback to local cache
                try { return new Set(JSON.parse(localStorage.getItem(STORAGE_KEYS.busyBoards) || '[]')); } catch { return new Set(); }
            } else {
                try { return new Set(JSON.parse(localStorage.getItem(STORAGE_KEYS.busyBoards) || '[]')); } catch { return new Set(); }
            }
        }
        function setBusyBoards(set) {
            localStorage.setItem(STORAGE_KEYS.busyBoards, JSON.stringify(Array.from(set)));
            if (realtime.enabled) {
                const obj = {};
                Array.from(set).forEach(id => obj[id] = true);
                // write full state (simple cooperative demo)
                firebase.database().ref('busyBoards').set(obj).catch(()=>{});
            }
        }

        function updateInviteLinks() {
            BOARD_IDS.forEach(id => {
                const url = new URL(window.location.href);
                url.searchParams.set('board', String(id));
                const a = document.getElementById(`invite-${id}`);
                a.href = url.toString();
                a.addEventListener('click', (e) => {
                    e.preventDefault();
                    navigator.clipboard.writeText(a.href).then(() => {
                        a.textContent = 'Copied!';
                        setTimeout(() => { a.innerHTML = '<i class="fa-solid fa-link"></i> Invite'; }, 1200);
                    });
                });
            });
        }

        function getWatchers(boardId) {
            return parseInt(localStorage.getItem(STORAGE_KEYS.watchersPrefix + boardId) || '0', 10);
        }
        function setWatchers(boardId, count) {
            localStorage.setItem(STORAGE_KEYS.watchersPrefix + boardId, String(Math.max(0, count)));
        }
        function renderWatchers() {
            BOARD_IDS.forEach(id => {
                document.getElementById(`watchers-${id}`).textContent = String(getWatchers(id));
            });
        }

        function setActiveBoard(boardId) {
            localStorage.setItem(STORAGE_KEYS.activeBoard, String(boardId));
            if (realtime.enabled) {
                updateRealtimePresence(boardId);
            }
            applyBlurStates();
        }
        function getActiveBoard() {
            return parseInt(localStorage.getItem(STORAGE_KEYS.activeBoard) || '0', 10) || null;
        }
        function applyBlurStates() {
            const active = getActiveBoard();
            BOARD_IDS.forEach(id => {
                const boardEl = document.getElementById(`board-${id}`);
                const two = boardHasTwoPlayers.get(id) === true;
                const shouldReveal = (active === id);
                const btn = document.querySelector(`#board-card-${id} .reveal-btn`);
                if (shouldReveal) boardEl.classList.remove('board-blur'); else boardEl.classList.add('board-blur');
                // Hide reveal button once clicked (active board); show on others
                if (btn) {
                    if (active === id) btn.classList.add('hidden'); else btn.classList.remove('hidden');
                }
            });
        }

        function attachRevealHandlers() {
            document.querySelectorAll('.reveal-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const id = parseInt(btn.getAttribute('data-board'), 10);
                    setActiveBoard(id);
                    btn.classList.add('hidden');
                });
            });
            document.querySelectorAll('.join-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const id = parseInt(btn.getAttribute('data-board'), 10);
                    handleJoinBoard(id);
                });
            });
            document.querySelectorAll('.leave-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const id = parseInt(btn.getAttribute('data-board'), 10);
                    handleLeaveBoard(id);
                });
            });
            document.querySelectorAll('.flip-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const id = parseInt(btn.getAttribute('data-board'), 10);
                    const el = document.getElementById(`board-${id}`);
                    el.classList.toggle('board-flipped');
                });
            });
            document.querySelectorAll('.offer-draw-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const id = parseInt(btn.getAttribute('data-board'), 10);
                    offerDraw(id);
                });
            });
            document.querySelectorAll('.offer-takeback-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const id = parseInt(btn.getAttribute('data-board'), 10);
                    offerTakeback(id);
                });
            });
            document.querySelectorAll('.resign-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const id = parseInt(btn.getAttribute('data-board'), 10);
                    resignGame(id);
                });
            });
            // Allow moving by clicking two squares when active and joined
            BOARD_IDS.forEach(id => {
                const el = document.getElementById(`board-${id}`);
                let selected = null;
                let legalTargets = [];
                el.addEventListener('click', async (e) => {
                    const cell = e.target.closest('[data-square]');
                    if (!cell) return;
                    if (getActiveBoard() !== id) return;
                    if (!realtime.enabled) return; // online only
                    if (!boardMyColor.get(id)) return; // must be seated
                    const sq = cell.dataset.square;
                    if (!selected) {
                        // select only own piece and when it's your turn
                        const fen = boardFen.get(id);
                        const turn = (boardTurn.get(id) || 'w');
                        const my = boardMyColor.get(id);
                        if (!fen || my !== turn) return;
                        const game = new Chess();
                        try { game.load(fen); } catch { return; }
                        const piece = game.get(sq);
                        if (!piece || piece.color !== my) return;
                        selected = sq;
                        legalTargets = game.moves({ square: sq, verbose: true }).map(m => m.to);
                        highlightSelection(id, sq, legalTargets, game);
                        return;
                    }
                    const from = selected; const to = sq; selected = null; legalTargets = [];
                    clearHighlights(id);
                    if (!(await tryMakeMoveRealtime(id, from, to))) {
                        // if illegal, allow reselect if clicked own piece
                        const fen = boardFen.get(id);
                        const game = new Chess();
                        try { game.load(fen); } catch { return; }
                        const piece = game.get(sq);
                        const my = boardMyColor.get(id);
                        if (piece && piece.color === my) {
                            selected = sq;
                            const moves = game.moves({ square: sq, verbose: true });
                            legalTargets = moves.map(m => m.to);
                            highlightSelection(id, sq, legalTargets, game);
                        }
                    }
                });
            });
        }

        function clearHighlights(boardId) {
            const el = document.getElementById(`board-${boardId}`);
            el.querySelectorAll('[data-square]').forEach(sq => {
                sq.classList.remove('hl-selected','hl-dot','hl-capture');
            });
        }
        function highlightSelection(boardId, from, targets, game) {
            const el = document.getElementById(`board-${boardId}`);
            clearHighlights(boardId);
            const fromEl = el.querySelector(`[data-square="${from}"]`);
            if (fromEl) fromEl.classList.add('hl-selected');
            targets.forEach(t => {
                const toEl = el.querySelector(`[data-square="${t}"]`);
                if (!toEl) return;
                const capture = game.get(t);
                toEl.classList.add('hl-dot');
                if (capture) toEl.classList.add('hl-capture');
            });
        }

        function maybeSelectBoardFromUrl() {
            const url = new URL(window.location.href);
            const id = parseInt(url.searchParams.get('board') || '0', 10);
            if (id && BOARD_IDS.includes(id)) {
                setActiveBoard(id);
                if (!realtime.enabled) {
                    // Bump watchers for selected board locally
                    setWatchers(id, getWatchers(id) + 1);
                    renderWatchers();
                }
            }
        }

        function setupQueueAndBooking() {
            const bookBtn = document.getElementById('bookSlotBtn');
            bookBtn.addEventListener('click', async () => {
                if (realtime.enabled) {
                    try {
                        const snap = await firebase.database().ref('busyBoards').get();
                        const busyMap = snap.exists() ? snap.val() : {};
                        const busy = new Set(Object.keys(busyMap || {}).map(n => parseInt(n,10)));
                        const free = BOARD_IDS.find(id => !busy.has(id));
                        if (free) {
                            busy.add(free);
                            setBusyBoards(busy);
                            setActiveBoard(free);
                            alert(`You got Board ${free}. Share the invite to play!`);
                            return;
                        }
                        // enqueue cooperatively
                        const token = crypto.randomUUID ? crypto.randomUUID() : String(Date.now());
                        const ref = firebase.database().ref('queue').push();
                        await ref.set({ token, time: Date.now() });
                        alert('All boards busy. You are added to the waitlist. Keep this tab open.');
                    } catch (e) {
                        alert('Network issue. Please try again.');
                    }
                } else {
                    const busy = getBusyBoards();
                    const free = BOARD_IDS.find(id => !busy.has(id));
                    if (free) {
                        busy.add(free);
                        setBusyBoards(busy);
                        setActiveBoard(free);
                        alert(`You got Board ${free}. Share the invite to play!`);
                        return;
                    }
                    const q = getQueue();
                    const token = crypto.randomUUID ? crypto.randomUUID() : String(Date.now());
                    q.push({ token, time: Date.now() });
                    setQueue(q);
                    alert('All boards busy. You are added to the waitlist. Keep this tab open.');
                }
            });

            // Demo: free up a board after leaving or via reset button
            window.addEventListener('beforeunload', () => {
                // No-op demo; real app would signal server
            });
        }

        function setupReset() {
            document.getElementById('clearLocalBtn').addEventListener('click', () => {
                BOARD_IDS.forEach(id => localStorage.removeItem(STORAGE_KEYS.watchersPrefix + id));
                localStorage.removeItem(STORAGE_KEYS.activeBoard);
                localStorage.removeItem(STORAGE_KEYS.queue);
                localStorage.removeItem(STORAGE_KEYS.busyBoards);
                if (realtime.enabled) {
                    // Clear my presence
                    updateRealtimePresence(null);
                }
                renderWatchers();
                applyBlurStates();
            });
        }

        // Realtime helpers
        function updateRealtimePresence(boardId) {
            if (!realtime.enabled) return;
            const prev = realtime.currentWatching;
            if (prev && prev !== boardId) {
                const prevRef = firebase.database().ref(`boards/${prev}/watchers/${realtime.myId}`);
                prevRef.remove().catch(()=>{});
            }
            if (boardId) {
                const ref = firebase.database().ref(`boards/${boardId}/watchers/${realtime.myId}`);
                ref.set(true).catch(()=>{});
                ref.onDisconnect().remove().catch(()=>{});
                realtime.currentWatching = boardId;
            } else {
                realtime.currentWatching = null;
            }
        }

        function subscribeWatchersRealtime(boardId) {
            if (!realtime.enabled) return;
            const ref = firebase.database().ref(`boards/${boardId}/watchers`);
            ref.on('value', snap => {
                const val = snap.val() || {};
                const count = Object.keys(val).length;
                setWatchers(boardId, count);
                renderWatchers();
            });
        }

        function subscribeBusyBoardsRealtime() {
            if (!realtime.enabled) return;
            const ref = firebase.database().ref('busyBoards');
            ref.on('value', snap => {
                const val = snap.val() || {};
                const set = new Set(Object.keys(val).map(n => parseInt(n,10)));
                setBusyBoards(set); // also mirrors to local cache
            });
        }

        // Minimal online match state
        function boardRef(id) {
            return firebase.database().ref(`boards/${id}`);
        }
        function handleJoinBoard(id) {
            if (!realtime.enabled) {
                alert('Enable Firebase to play online. You can still spectate.');
                return;
            }
            const statusEl = document.getElementById(`status-${id}`);
            const ref = boardRef(id);
            ref.transaction(current => {
                current = current || {};
                current.players = current.players || {};
                // assign color
                if (!current.players.white) current.players.white = realtime.myId;
                else if (!current.players.black) current.players.black = realtime.myId;
                current.fen = current.fen || 'rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1';
                current.turn = current.turn || 'w';
                current.updatedAt = Date.now();
                return current;
            }).then(() => {
                statusEl.textContent = 'Joined. Waiting for opponent or playing...';
                listenBoardState(id);
            }).catch(() => {
                alert('Failed to join board.');
            });
        }
        function handleLeaveBoard(id) {
            if (!realtime.enabled) return;
            const statusEl = document.getElementById(`status-${id}`);
            const ref = boardRef(id).child('players');
            ref.transaction(players => {
                if (!players) return players;
                Object.keys(players).forEach(color => {
                    if (players[color] === realtime.myId) players[color] = null;
                });
                return players;
            }).finally(async () => {
                statusEl.textContent = 'Idle';
                // If less than 2 players remain, blur board again
                try {
                    const snap = await boardRef(id).child('players').get();
                    const p = snap.val() || {};
                    const two = Boolean(p.white) && Boolean(p.black);
                    boardHasTwoPlayers.set(id, two);
                    applyBlurStates();
                } catch {}
            });
        }
        function listenBoardState(id) {
            if (!realtime.enabled) return;
            boardRef(id).on('value', snap => {
                const v = snap.val() || {};
                const statusEl = document.getElementById(`status-${id}`);
                const players = (v.players)||{};
                const myColor = players.white === realtime.myId ? 'w' : (players.black === realtime.myId ? 'b' : null);
                statusEl.textContent = `Players: ${players.white? 'W✓':'W·'} ${players.black? 'B✓':'B·'}${myColor? ' • You: '+(myColor==='w'?'White':'Black'):''}`;
                boardMyColor.set(id, myColor);
                const two = Boolean(players.white) && Boolean(players.black);
                boardHasTwoPlayers.set(id, two);
                applyBlurStates();
                // render pieces if fen present
                if (v.fen && v.fen !== 'start') {
                    const boardEl = document.getElementById(`board-${id}`);
                    renderFenToBoard(boardEl, v.fen);
                    boardFen.set(id, v.fen);
                    boardTurn.set(id, v.turn || 'w');
                    if (v.lastMove && v.lastMove.from && v.lastMove.to) highlightLastMove(id, v.lastMove.from, v.lastMove.to);
                } else if (v.fen === 'start') {
                    const boardEl = document.getElementById(`board-${id}`);
                    renderFenToBoard(boardEl, 'rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR');
                    boardFen.set(id, 'rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1');
                    boardTurn.set(id, 'w');
                }
                // handle offers UI
                const area = document.getElementById(`offer-area-${id}`);
                area.innerHTML = '';
                if (v.offer && myColor) {
                    if (v.offer.type === 'draw' && v.offer.to === myColor) {
                        const accept = document.createElement('button');
                        accept.className = 'px-3 py-1 rounded-full text-white bg-emerald-600 mr-2';
                        accept.textContent = 'Accept Draw';
                        accept.onclick = () => acceptDraw(id);
                        const decline = document.createElement('button');
                        decline.className = 'px-3 py-1 rounded-full text-indigo-700 bg-white border border-indigo-200';
                        decline.textContent = 'Decline';
                        decline.onclick = () => clearOffer(id);
                        area.appendChild(accept);
                        area.appendChild(decline);
                    }
                    if (v.offer.type === 'takeback' && v.offer.to === myColor) {
                        const accept = document.createElement('button');
                        accept.className = 'px-3 py-1 rounded-full text-white bg-amber-600 mr-2';
                        accept.textContent = 'Accept Takeback';
                        accept.onclick = () => acceptTakeback(id);
                        const decline = document.createElement('button');
                        decline.className = 'px-3 py-1 rounded-full text-indigo-700 bg-white border border-indigo-200';
                        decline.textContent = 'Decline';
                        decline.onclick = () => clearOffer(id);
                        area.appendChild(accept);
                        area.appendChild(decline);
                    }
                }
            });
        }

        function highlightLastMove(boardId, from, to) {
            const el = document.getElementById(`board-${boardId}`);
            el.querySelectorAll('[data-square]').forEach(sq => sq.classList.remove('hl-last'));
            const a = el.querySelector(`[data-square="${from}"]`);
            const b = el.querySelector(`[data-square="${to}"]`);
            if (a) a.classList.add('hl-last');
            if (b) b.classList.add('hl-last');
        }

        function renderFenToBoard(container, fen) {
            // Clear existing pieces
            container.querySelectorAll('.piece').forEach(p => p.remove());
            container.querySelectorAll('.piece-img').forEach(p => p.remove());
            container.querySelectorAll('.piece-sprite').forEach(p => p.remove());
            const rows = fen.split(' ')[0].split('/');
            for (let r = 0; r < 8; r++) {
                let fileIndex = 0;
                for (const ch of rows[r]) {
                    if (/\d/.test(ch)) { fileIndex += parseInt(ch,10); continue; }
                    const fileChar = String.fromCharCode('a'.charCodeAt(0) + fileIndex);
                    const rank = 8 - r;
                    const sq = `${fileChar}${rank}`;
                    const cell = container.querySelector(`[data-square="${sq}"]`);
                    if (cell) {
                        const img = document.createElement('div');
                        if (window.CHESS_SPRITE_URL) {
                            img.className = 'piece-sprite';
                            img.style.backgroundImage = `url(${window.CHESS_SPRITE_URL})`;
                            const pos = spritePos(ch);
                            img.style.backgroundPosition = pos;
                        } else {
                            img.className = 'piece-img';
                            img.style.backgroundImage = `url(${pieceImageUrl(ch)})`;
                        }
                        cell.appendChild(img);
                    }
                    fileIndex += 1;
                }
            }
        }
        function spritePos(ch) {
            const order = ['K','Q','R','B','N','P'];
            const upper = ch.toUpperCase();
            const isWhite = ch === upper;
            const col = order.indexOf(upper);
            const x = (col / 5) * 100; // 0..100
            const y = isWhite ? 0 : 100;
            return `${x}% ${y}%`;
        }
        function pieceImageUrl(ch) {
            const base = 'https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/img/chesspieces/wikipedia';
            const isWhite = ch === ch.toUpperCase();
            const type = ch.toUpperCase();
            const file = (isWhite ? 'w' : 'b') + type + '.png';
            return `${base}/${file}`;
        }
        async function tryMakeMoveRealtime(id, from, to) {
            if (!realtime.enabled) return;
            const ref = boardRef(id);
            const snap = await ref.get();
            const v = snap.exists() ? snap.val() : {};
            const players = v.players || {};
            const myColor = players.white === realtime.myId ? 'w' : (players.black === realtime.myId ? 'b' : null);
            if (!myColor) { alert('Join this board first.'); return false; }
            if ((v.turn || 'w') !== myColor) { return false; }

            const game = new Chess();
            const startFen = 'rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1';
            try { game.load(v.fen || startFen); } catch { game.load(startFen); }

            const move = game.move({ from, to, promotion: 'q' });
            if (!move) { return false; }

            await ref.update({
                fen: game.fen(),
                turn: game.turn(),
                lastMove: { from, to, t: Date.now() }
            });
            return true;
        }

        function offerDraw(id) {
            if (!realtime.enabled) return;
            boardRef(id).transaction(v => {
                v = v || {}; v.players = v.players || {}; v.turn = v.turn || 'w';
                const mine = v.players.white === realtime.myId ? 'w' : (v.players.black === realtime.myId ? 'b' : null);
                if (!mine) return v;
                const opp = mine === 'w' ? 'b' : 'w';
                v.offer = { type: 'draw', from: mine, to: opp, t: Date.now() };
                return v;
            });
        }
        function clearOffer(id) { boardRef(id).child('offer').remove().catch(()=>{}); }
        function acceptDraw(id) {
            if (!realtime.enabled) return;
            boardRef(id).update({ result: '1/2-1/2', offer: null });
        }
        function offerTakeback(id) {
            if (!realtime.enabled) return;
            boardRef(id).transaction(v => {
                v = v || {}; v.players = v.players || {}; v.turn = v.turn || 'w';
                const mine = v.players.white === realtime.myId ? 'w' : (v.players.black === realtime.myId ? 'b' : null);
                if (!mine) return v;
                const opp = mine === 'w' ? 'b' : 'w';
                v.offer = { type: 'takeback', from: mine, to: opp, t: Date.now() };
                return v;
            });
        }
        async function acceptTakeback(id) {
            const ref = boardRef(id);
            const snap = await ref.get();
            const v = snap.exists() ? snap.val() : {};
            if (!v.fen || !v.lastMove) { clearOffer(id); return; }
            // Simple takeback: we can't reconstruct previous FEN without history.
            // As a compromise, switch turn back only (visual only). For full takeback we'd store history.
            await ref.update({ turn: (v.turn === 'w' ? 'b' : 'w'), offer: null });
        }
        function resignGame(id) {
            if (!realtime.enabled) return;
            boardRef(id).transaction(v => {
                v = v || {}; v.players = v.players || {};
                const mine = v.players.white === realtime.myId ? 'w' : (v.players.black === realtime.myId ? 'b' : null);
                if (!mine) return v;
                v.result = mine === 'w' ? '0-1' : '1-0';
                return v;
            });
        }

        // Initialize
        initBoards();
        attachRevealHandlers();
        updateInviteLinks();
        renderWatchers();
        // Default: none visible until revealed or via URL
        setActiveBoard(null);
        maybeSelectBoardFromUrl();
        setupQueueAndBooking();
        setupReset();
    </script>

</body>

</html>


